name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # –£—Å—Ç–∞–Ω–æ–≤–∏–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º
            set -e
            
            echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!"
            
            # ========== CHESS API ==========
            echo "üöÄ –î–µ–ø–ª–æ–π Chess API..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏
            if [ ! -d "/opt/chessapi" ]; then
              echo "‚ùå –ü–∞–ø–∫–∞ /opt/chessapi –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              exit 1
            fi
            
            cd /opt/chessapi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git pull origin main || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å git"
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            mvn clean package -DskipTests || {
              echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ API"
              exit 1
            }
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker stop chessapi 2>/dev/null || true
            docker rm chessapi 2>/dev/null || true
            
            # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
            docker build -t chessapi:latest . || {
              echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞ API"
              exit 1
            }
            
            # –ó–ê–ü–£–°–ö–ê–ï–ú API –° –ü–û–†–¢–û–ú 8080:8080
            echo "–ó–∞–ø—É—Å–∫–∞–µ–º chessapi —Å –ø–æ—Ä—Ç–æ–º 8080:8080..."
            docker run -d \
              --name chessapi \
              -p 8080:8080 \
              chessapi:latest \
              --server.port=8080 \
              --server.address=0.0.0.0 \
              --spring.datasource.url=jdbc:postgresql://localhost:5432/chessdb \
              --spring.datasource.username=postgres \
              --spring.datasource.password=postgres || {
                echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ chessapi"
                docker logs chessapi --tail 20 2>/dev/null || true
                exit 1
              }
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ API (20 —Å–µ–∫—É–Ω–¥)..."
            sleep 20
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º API
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º API..."
            if curl -s --max-time 10 http://localhost:8080/actuator/health > /dev/null; then
              echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            else
              echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
              docker logs chessapi --tail 30
              exit 1
            fi