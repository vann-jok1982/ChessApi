name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!"
            
            cd /opt/chessapi
            
            # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ JAR —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º JAR —Ñ–∞–π–ª..."
            JAR_FILE=$(find target -name "*.jar" | head -1)
            if [ -z "$JAR_FILE" ]; then
              echo "‚ùå JAR —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
              mvn clean package -DskipTests
              JAR_FILE=$(find target -name "*.jar" | head -1)
            fi
            
            echo "üì¶ JAR —Ñ–∞–π–ª: $JAR_FILE"
            
            # 2. –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Dockerfile
            echo "üìù –°–æ–∑–¥–∞–µ–º Dockerfile..."
            cat > Dockerfile << 'DOCKERFILEEOF'
            FROM eclipse-temurin:17-jre
            WORKDIR /app
            COPY $JAR_FILE app.jar
            EXPOSE 8080
            ENTRYPOINT ["java", "-jar", "app.jar"]
            DOCKERFILEEOF
            
            # 3. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
            echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑..."
            docker build -t chessapi:latest .
            
            # 4. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º chessapi..."
            docker stop chessapi 2>/dev/null || true
            docker rm chessapi 2>/dev/null || true
            
            docker run -d \
              --name chessapi \
              -p 8080:8080 \
              chessapi:latest \
              --server.port=8080 \
              --server.address=0.0.0.0 \
              --spring.datasource.url=jdbc:postgresql://localhost:5432/chessdb \
              --spring.datasource.username=postgres \
              --spring.datasource.password=postgres
            
            # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞..."
            sleep 20
            
            if curl -s http://localhost:8080/actuator/health > /dev/null; then
              echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            else
              echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
              docker logs chessapi --tail 20
              exit 1
            fi